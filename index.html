<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TQQQ LRS ç­–ç•¥å„€è¡¨æ¿ - åŸºæ–¼ Leverage for the Long Run è«–æ–‡</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#0f0f23 0%,#1a1a40 50%,#2d1b69 100%);min-height:100vh;color:#fff}
    .container{max-width:1600px;margin:0 auto;padding:20px}
    .header{text-align:center;margin-bottom:30px}
    .header h1{font-size:2.8rem;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.5);background:linear-gradient(45deg,#60a5fa,#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .header .subtitle{font-size:1.1rem;color:#a1a1aa;margin-bottom:15px}
    .last-updated{background:rgba(96,165,250,.2);padding:8px 16px;border-radius:20px;display:inline-block;backdrop-filter:blur(10px);border:1px solid rgba(96,165,250,.3)}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;margin-bottom:30px}
    .card{background:rgba(255,255,255,.08);border-radius:16px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,.3);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);transition:transform .3s ease,box-shadow .3s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 40px rgba(0,0,0,.4)}
    .card-title{font-size:1.3rem;font-weight:600;margin-bottom:20px;color:#e4e4e7;display:flex;align-items:center;gap:8px}
    .signal-card{text-align:center;position:relative;overflow:hidden;background:linear-gradient(135deg,rgba(34,197,94,.15),rgba(59,130,246,.15))}
    .signal-status{font-size:3.5rem;font-weight:bold;margin:20px 0;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .signal-tqqq{color:#22c55e;animation:pulse 2s ease-in-out infinite}
    .signal-cash{color:#ef4444}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .signal-description{font-size:1.1rem;color:#d1d5db;margin-bottom:16px}
    .action-required{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#000;padding:12px 24px;border-radius:8px;font-weight:600;font-size:1.1rem;animation:glow 2s ease-in-out infinite alternate}
    @keyframes glow{from{box-shadow:0 0 20px rgba(251,191,36,.4)}to{box-shadow:0 0 30px rgba(251,191,36,.8)}}
    .metric{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.1)}
    .metric:last-child{border-bottom:none}
    .metric-label{color:#a1a1aa;font-size:.95rem}
    .metric-value{font-weight:600;font-size:1.1rem;color:#e4e4e7}
    .positive{color:#22c55e}
    .negative{color:#ef4444}
    .neutral{color:#60a5fa}
    .warning{color:#fbbf24}
    .danger{color:#ef4444}
    .chart-container{grid-column:1 / -1;height:400px}
    .chart-dual{grid-column:1 / -1;display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .loading{text-align:center;color:#a1a1aa;font-size:1.2rem;margin:40px 0}
    .loading::after{content:'...';animation:dots 1.5s steps(4,end) infinite}
    @keyframes dots{0%,20%{content:''}40%{content:'.'}60%{content:'..'}80%,100%{content:'...'}}
    .refresh-btn{background:rgba(96,165,250,.2);border:1px solid rgba(96,165,250,.3);color:#e4e4e7;padding:8px 16px;border-radius:8px;cursor:pointer;transition:all .3s ease;backdrop-filter:blur(10px)}
    .refresh-btn:hover{background:rgba(96,165,250,.3);transform:scale(1.05)}
    .alert{background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;padding:16px;border-radius:8px;margin-bottom:20px;text-align:center;font-weight:600}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;margin-left:8px}
    .badge-ok{background:#16a34a;color:white}
    .badge-fail{background:#dc2626;color:white}
    .volatility-meter{width:100%;height:20px;background:linear-gradient(90deg,#22c55e 0%,#fbbf24 40%,#ef4444 70%);border-radius:10px;position:relative;margin:10px 0}
    .volatility-indicator{position:absolute;top:50%;transform:translate(-50%,-50%);width:4px;height:24px;background:#fff;border-radius:2px;box-shadow:0 0 10px rgba(0,0,0,.5)}
    .streak-visualization{display:flex;gap:2px;margin:10px 0;flex-wrap:wrap}
    .streak-day{width:12px;height:12px;border-radius:2px;margin:1px}
    .streak-up{background:#22c55e}
    .streak-down{background:#ef4444}
    .streak-neutral{background:#6b7280}
    .performance-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin:15px 0}
    .performance-item{text-align:center;padding:10px;background:rgba(255,255,255,.05);border-radius:8px}
    .performance-value{font-size:1.5rem;font-weight:bold;margin-bottom:5px}
    .performance-label{font-size:.8rem;color:#a1a1aa}
    .risk-gauge{position:relative;width:100px;height:50px;margin:10px auto}
    .gauge-bg{width:100%;height:100%;border-radius:100px 100px 0 0;background:conic-gradient(from 180deg,#22c55e 0deg,#fbbf24 90deg,#ef4444 180deg)}
    .gauge-needle{position:absolute;bottom:0;left:50%;width:2px;height:40px;background:#fff;transform-origin:bottom;transition:transform .5s ease}
    .api-status{font-size:.9rem;margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š TQQQ LRS ç­–ç•¥å„€è¡¨æ¿</h1>
      <div class="subtitle">åŸºæ–¼ "Leverage for the Long Run" è«–æ–‡ - ç³»çµ±æ€§æ§“æ¡¿è¼ªå‹•ç­–ç•¥ (Alpha Vantage API)</div>
      <div class="last-updated">
        <span id="lastUpdate">è¼‰å…¥ä¸­...</span>
        <button class="refresh-btn" onclick="refreshData()">ğŸ”„ æ›´æ–°æ•¸æ“š</button>
        <span id="apiHealth" class="badge">API æª¢æ¸¬ä¸­</span>
      </div>
      <div id="apiStatus" class="api-status"></div>
    </div>

    <div id="loadingIndicator" class="loading">æ­£åœ¨è¼‰å…¥å¸‚å ´æ•¸æ“šå’Œè¨ˆç®—æŠ€è¡“æŒ‡æ¨™</div>
    <div id="errorAlert" class="alert" style="display:none;">âš ï¸ ç„¡æ³•è¼‰å…¥æ•¸æ“šï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œé‡è©¦</div>

    <div id="dashboardContent" class="dashboard" style="display:none;">
      <!-- æ ¸å¿ƒç­–ç•¥ä¿¡è™Ÿ -->
      <div class="card signal-card">
        <h2 class="card-title">ğŸ¯ LRS æ ¸å¿ƒä¿¡è™Ÿ</h2>
        <div id="signalStatus" class="signal-status">è¼‰å…¥ä¸­...</div>
        <div id="signalDescription" class="signal-description">åˆ†æä¸­...</div>
        <div class="metric">
          <span class="metric-label">ç§»å‹•å¹³å‡ç·šé€±æœŸ</span>
          <span class="metric-value">200æ—¥ SMA</span>
        </div>
        <div class="metric">
          <span class="metric-label">ç•¶å‰ä¿¡è™Ÿå¼·åº¦</span>
          <span id="signalStrength" class="metric-value">--</span>
        </div>
        <div id="actionRequired" class="action-required" style="display:none;">éœ€è¦èª¿æ•´å€‰ä½ï¼</div>
      </div>

      <!-- QQQ åŸºç¤æŒ‡æ¨™ -->
      <div class="card">
        <h2 class="card-title">ğŸ“ˆ QQQ åƒ¹æ ¼å‹•æ…‹</h2>
        <div class="metric">
          <span class="metric-label">ç•¶å‰åƒ¹æ ¼</span>
          <span id="qqqPrice" class="metric-value">$--</span>
        </div>
        <div class="metric">
          <span class="metric-label">200æ—¥ç§»å‹•å¹³å‡</span>
          <span id="qqqSma200" class="metric-value">$--</span>
        </div>
        <div class="metric">
          <span class="metric-label">è·é›¢å‡ç·šç™¾åˆ†æ¯”</span>
          <span id="qqqDistance" class="metric-value">--%</span>
        </div>
        <div class="metric">
          <span class="metric-label">æ—¥è®ŠåŒ–</span>
          <span id="qqqChange" class="metric-value">--%</span>
        </div>
        <div class="metric">
          <span class="metric-label">20æ—¥å¹³å‡çœŸå¯¦æ³¢å‹•ç‡</span>
          <span id="qqqAtr" class="metric-value">--%</span>
        </div>
      </div>

      <!-- æ³¢å‹•ç‡åˆ†æï¼ˆè«–æ–‡æ ¸å¿ƒï¼‰ -->
      <div class="card">
        <h2 class="card-title">âš¡ æ³¢å‹•ç‡åˆ†æï¼ˆé—œéµé¢¨éšªå› å­ï¼‰</h2>
        <div class="metric">
          <span class="metric-label">ç•¶å‰å¹´åŒ–æ³¢å‹•ç‡</span>
          <span id="currentVolatility" class="metric-value">--%</span>
        </div>
        <div class="metric">
          <span class="metric-label">è¶¨å‹¢å…§å¹³å‡æ³¢å‹•ç‡</span>
          <span id="trendVolatility" class="metric-value">--%</span>
        </div>
        <div class="metric">
          <span class="metric-label">è¶¨å‹¢å¤–å¹³å‡æ³¢å‹•ç‡</span>
          <span id="nonTrendVolatility" class="metric-value">--%</span>
        </div>
        <div class="volatility-meter">
          <div id="volatilityIndicator" class="volatility-indicator"></div>
        </div>
        <div style="font-size:.85rem;color:#a1a1aa;text-align:center;margin-top:5px">
          ä½é¢¨éšª â† æ§“æ¡¿é©ç”¨åº¦ â†’ é«˜é¢¨éšª
        </div>
      </div>

      <!-- é€£çºŒæ€§èƒ½åˆ†æ -->
      <div class="card">
        <h2 class="card-title">ğŸ“Š é€£çºŒè¡¨ç¾åˆ†æï¼ˆStreak Analysisï¼‰</h2>
        <div class="metric">
          <span class="metric-label">ç›®å‰é€£çºŒè¶¨å‹¢</span>
          <span id="currentStreak" class="metric-value">-- å¤©</span>
        </div>
        <div class="metric">
          <span class="metric-label">è¶¨å‹¢å…§é€£çºŒä¸Šæ¼²æ©Ÿç‡</span>
          <span id="upStreakProb" class="metric-value">--%</span>
        </div>
        <div class="metric">
          <span class="metric-label">è¿‘20æ—¥è¡¨ç¾æ¨¡å¼</span>
          <span id="recentPattern" class="metric-value">--</span>
        </div>
        <div class="streak-visualization" id="streakVisualization">
          <!-- å‹•æ…‹ç”Ÿæˆé€£çºŒè¡¨ç¾è¦–è¦ºåŒ– -->
        </div>
      </div>

      <!-- TQQQ æ§“æ¡¿è¡¨ç¾ -->
      <div class="card">
        <h2 class="card-title">ğŸš€ TQQQ æ§“æ¡¿è¡¨ç¾</h2>
        <div class="metric">
          <span class="metric-label">ç•¶å‰åƒ¹æ ¼</span>
          <span id="tqqqPrice" class="metric-value">$--</span>
        </div>
        <div class="metric">
          <span class="metric-label">æ§“æ¡¿æ•ˆç‡ (vs 3x QQQ)</span>
          <span id="leverageEfficiency" class="metric-value">--%</span>
        </div>
        <div class="metric">
          <span class="metric-label">è·¯å¾‘ä¾è³´æå¤±</span>
          <span id="pathDecay" class="metric-value">--%</span>
        </div>
        <div class="metric">
          <span class="metric-label">è¤‡åˆ©æ‹–ç´¯æŒ‡æ•¸</span>
          <span id="compoundingDrag" class="metric-value">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">Beta (ç›¸å°QQQ)</span>
          <span id="tqqqBeta" class="metric-value">--</span>
        </div>
      </div>

      <!-- ç­–ç•¥ç¸¾æ•ˆæŒ‡æ¨™ -->
      <div class="card">
        <h2 class="card-title">ğŸ“ˆ LRS ç­–ç•¥ç¸¾æ•ˆ</h2>
        <div class="performance-grid">
          <div class="performance-item">
            <div id="strategyReturn" class="performance-value positive">--%</div>
            <div class="performance-label">å¹´åŒ–å ±é…¬ç‡</div>
          </div>
          <div class="performance-item">
            <div id="strategySharpe" class="performance-value">--</div>
            <div class="performance-label">å¤æ™®æ¯”ç‡</div>
          </div>
          <div class="performance-item">
            <div id="strategySortino" class="performance-value">--</div>
            <div class="performance-label">ç´¢æè«¾æ¯”ç‡</div>
          </div>
          <div class="performance-item">
            <div id="maxDrawdown" class="performance-value negative">--%</div>
            <div class="performance-label">æœ€å¤§å›æ’¤</div>
          </div>
        </div>
        <div class="metric">
          <span class="metric-label">ç­–ç•¥Alpha (ç›¸å°QQQ)</span>
          <span id="strategyAlpha" class="metric-value">--%</span>
        </div>
        <div class="metric">
          <span class="metric-label">å¹´å‡äº¤æ˜“æ¬¡æ•¸</span>
          <span id="avgTrades" class="metric-value">-- æ¬¡</span>
        </div>
      </div>

      <!-- å¸‚å ´ç’°å¢ƒè©•ä¼° -->
      <div class="card">
        <h2 class="card-title">ğŸŒ¡ï¸ å¸‚å ´ç’°å¢ƒè©•ä¼°</h2>
        <div class="metric">
          <span class="metric-label">ç¶“æ¿Ÿé€±æœŸéšæ®µ</span>
          <span id="economicCycle" class="metric-value">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">æ§“æ¡¿é©ç”¨æ€§è©•åˆ†</span>
          <span id="leverageSuitability" class="metric-value">--/10</span>
        </div>
        <div class="metric">
          <span class="metric-label">å¸‚å ´æƒ…ç·’æŒ‡æ¨™</span>
          <span id="marketSentiment" class="metric-value">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">ææ…Œè²ªå©ªæŒ‡æ•¸</span>
          <span id="fearGreedIndex" class="metric-value">--</span>
        </div>
        <div class="risk-gauge">
          <div class="gauge-bg"></div>
          <div id="riskNeedle" class="gauge-needle"></div>
        </div>
      </div>

      <!-- é¢¨éšªç®¡ç†æŒ‡æ¨™ -->
      <div class="card">
        <h2 class="card-title">âš ï¸ é¢¨éšªç®¡ç†æŒ‡æ¨™</h2>
        <div class="metric">
          <span class="metric-label">æ§“æ¡¿é™·é˜±é¢¨éšª</span>
          <span id="leverageTrapRisk" class="metric-value">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">è·¯å¾‘ä¾è³´é¢¨éšª</span>
          <span id="pathDependencyRisk" class="metric-value">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">ç ´ç”¢é¢¨éšªè©•ä¼°</span>
          <span id="ruinRisk" class="metric-value">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">å»ºè­°æœ€å¤§æ§“æ¡¿</span>
          <span id="maxRecommendedLeverage" class="metric-value">--x</span>
        </div>
        <div class="metric">
          <span class="metric-label">æ­¢æå»ºè­°</span>
          <span id="stopLossLevel" class="metric-value">--</span>
        </div>
      </div>

      <!-- äº¤æ˜“å»ºè­° -->
      <div class="card">
        <h2 class="card-title">ğŸ’¡ æ™ºèƒ½äº¤æ˜“å»ºè­°</h2>
        <div id="tradingRecommendations" style="line-height:1.6;color:#d1d5db;">
          <div class="loading">åˆ†æå¸‚å ´æ¢ä»¶ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- åœ–è¡¨å€åŸŸ -->
    <div id="chartSection" style="display:none;">
      <div class="chart-dual">
        <div class="card chart-container">
          <h2 class="card-title">ğŸ“ˆ QQQ vs 200æ—¥å‡ç·š (å«ç­–ç•¥ä¿¡è™Ÿ)</h2>
          <canvas id="priceChart"></canvas>
        </div>
        <div class="card chart-container">
          <h2 class="card-title">ğŸ“Š æ³¢å‹•ç‡ vs æ§“æ¡¿è¡¨ç¾</h2>
          <canvas id="volatilityChart"></canvas>
        </div>
      </div>
      
      <div class="card chart-container" style="grid-column:1/-1;">
        <h2 class="card-title">ğŸ¯ LRS ç­–ç•¥ç´¯ç©å ±é…¬ vs è²·å…¥æŒæœ‰</h2>
        <canvas id="performanceChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ====== Alpha Vantage API è¨­å®š ======
    const ALPHA_VANTAGE_KEY = 'J8WGSIJ73G3YAPGG';
    const AV_BASE = 'https://www.alphavantage.co/query';
    
    // è«‹æ±‚é€Ÿç‡é™åˆ¶ç®¡ç†
    let lastRequestTime = 0;
    const REQUEST_INTERVAL = 12000; // 12ç§’é–“éš”ï¼Œç¢ºä¿ä¸è¶…é 5 requests/minute

    async function rateLimitedFetch(url) {
      const now = Date.now();
      const timeSinceLastRequest = now - lastRequestTime;
      
      if (timeSinceLastRequest < REQUEST_INTERVAL) {
        await new Promise(resolve => setTimeout(resolve, REQUEST_INTERVAL - timeSinceLastRequest));
      }
      
      lastRequestTime = Date.now();
      return fetch(url);
    }

    // ====== å¿«å–æ©Ÿåˆ¶ ======
    const CACHE_PREFIX = 'tqqq_lrs_av_';
    const CACHE_DURATION = {
      INTRADAY: 5 * 60 * 1000,    // 5 minutes for intraday
      DAILY: 30 * 60 * 1000,      // 30 minutes for daily
      QUOTE: 2 * 60 * 1000        // 2 minutes for quotes
    };

    function getCacheKey(symbol, function_name, outputsize = 'compact') {
      return `${CACHE_PREFIX}${symbol}_${function_name}_${outputsize}`;
    }

    function getFromCache(key) {
      try {
        const cached = localStorage.getItem(key);
        if (!cached) return null;
        
        const { data, timestamp } = JSON.parse(cached);
        const age = Date.now() - timestamp;
        
        // æª¢æŸ¥å¿«å–æ˜¯å¦éæœŸ
        if (age > CACHE_DURATION.DAILY) {
          localStorage.removeItem(key);
          return null;
        }
        
        return data;
      } catch (e) {
        return null;
      }
    }

    function setCache(key, data, duration = CACHE_DURATION.DAILY) {
      try {
        const cacheData = {
          data: data,
          timestamp: Date.now()
        };
        localStorage.setItem(key, JSON.stringify(cacheData));
      } catch (e) {
        console.warn('ç„¡æ³•è¨­å®šå¿«å–:', e);
      }
    }

    // ====== Alpha Vantage API å‘¼å«å‡½æ•¸ ======
    async function getQuoteAV(symbol) {
      const cacheKey = getCacheKey(symbol, 'GLOBAL_QUOTE');
      const cached = getFromCache(cacheKey);
      
      if (cached) {
        console.log(`ä½¿ç”¨å¿«å–æ•¸æ“š: ${symbol}`);
        return cached;
      }

      const url = `${AV_BASE}?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_VANTAGE_KEY}`;
      
      try {
        const response = await rateLimitedFetch(url);
        const data = await response.json();
        
        if (data['Error Message']) {
          throw new Error(`Alpha Vantage Error: ${data['Error Message']}`);
        }
        
        if (data['Note']) {
          throw new Error('API call frequency limit reached');
        }

        const quote = data['Global Quote'];
        if (!quote) {
          throw new Error('ç„¡æ•ˆçš„å ±åƒ¹æ•¸æ“š');
        }

        const result = {
          symbol: quote['01. symbol'],
          price: parseFloat(quote['05. price']),
          change: parseFloat(quote['09. change']),
          changePercent: parseFloat(quote['10. change percent'].replace('%', '')),
          previousClose: parseFloat(quote['08. previous close']),
          open: parseFloat(quote['02. open']),
          high: parseFloat(quote['03. high']),
          low: parseFloat(quote['04. low']),
          volume: parseInt(quote['06. volume'])
        };

        setCache(cacheKey, result, CACHE_DURATION.QUOTE);
        return result;
      } catch (error) {
        console.error(`ç²å– ${symbol} å ±åƒ¹å¤±æ•—:`, error);
        throw error;
      }
    }

    async function getDailyDataAV(symbol, outputsize = 'compact') {
      const cacheKey = getCacheKey(symbol, 'TIME_SERIES_DAILY', outputsize);
      const cached = getFromCache(cacheKey);
      
      if (cached) {
        console.log(`ä½¿ç”¨å¿«å–æ—¥ç·šæ•¸æ“š: ${symbol}`);
        return cached;
      }

      const url = `${AV_BASE}?function=TIME_SERIES_DAILY&symbol=${symbol}&outputsize=${outputsize}&apikey=${ALPHA_VANTAGE_KEY}`;
      
      try {
        const response = await rateLimitedFetch(url);
        const data = await response.json();
        
        if (data['Error Message']) {
          throw new Error(`Alpha Vantage Error: ${data['Error Message']}`);
        }
        
        if (data['Note']) {
          throw new Error('API call frequency limit reached');
        }

        const timeSeries = data['Time Series (Daily)'];
        if (!timeSeries) {
          throw new Error('ç„¡æ•ˆçš„æ—¥ç·šæ•¸æ“š');
        }

        const dates = [];
        const opens = [];
        const highs = [];
        const lows = [];
        const closes = [];
        const volumes = [];

        // æŒ‰æ—¥æœŸæ’åº
        const sortedDates = Object.keys(timeSeries).sort();
        
        sortedDates.forEach(date => {
          const dayData = timeSeries[date];
          dates.push(date);
          opens.push(parseFloat(dayData['1. open']));
          highs.push(parseFloat(dayData['2. high']));
          lows.push(parseFloat(dayData['3. low']));
          closes.push(parseFloat(dayData['4. close']));
          volumes.push(parseInt(dayData['5. volume']));
        });

        const result = { dates, opens, highs, lows, closes, volumes };
        setCache(cacheKey, result, CACHE_DURATION.DAILY);
        return result;
      } catch (error) {
        console.error(`ç²å– ${symbol} æ—¥ç·šæ•¸æ“šå¤±æ•—:`, error);
        throw error;
      }
    }

    // ====== æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å‡½æ•¸ ======
    function computeSMA(arr, win) { 
      if (arr.length < win) return null; 
      const s = arr.slice(-win).reduce((a, b) => a + b, 0); 
      return s / win;
    }

    function computeATR(highs, lows, closes, period = 20) {
      if (closes.length < period + 1) return null;
      const trueRanges = [];
      for (let i = 1; i < closes.length; i++) {
        const tr = Math.max(
          highs[i] - lows[i],
          Math.abs(highs[i] - closes[i - 1]),
          Math.abs(lows[i] - closes[i - 1])
        );
        trueRanges.push(tr);
      }
      const atr = trueRanges.slice(-period).reduce((a, b) => a + b, 0) / period;
      return (atr / closes[closes.length - 1]) * 100;
    }

    function computeVolatility(prices, period = 20) {
      if (prices.length < period + 1) return null;
      const returns = [];
      for (let i = 1; i <= period; i++) {
        const ret = (prices[prices.length - i] - prices[prices.length - i - 1]) / prices[prices.length - i - 1];
        returns.push(ret);
      }
      const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
      const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (returns.length - 1);
      return Math.sqrt(variance) * Math.sqrt(252) * 100;
    }

    function computeStreakAnalysis(prices, sma200Array) {
      if (prices.length < 20 || sma200Array.length < 20) return null;
      
      const recent20 = [];
      for (let i = prices.length - 20; i < prices.length; i++) {
        if (i > 0 && sma200Array[i]) {
          const isUp = prices[i] > prices[i - 1];
          const isAboveSMA = prices[i] > sma200Array[i];
          recent20.push({ isUp, isAboveSMA });
        }
      }
      
      let currentStreak = 0;
      let streakType = null;
      for (let i = recent20.length - 1; i >= 0; i--) {
        if (streakType === null) {
          streakType = recent20[i].isUp ? 'up' : 'down';
          currentStreak = 1;
        } else if ((streakType === 'up' && recent20[i].isUp) || 
                  (streakType === 'down' && !recent20[i].isUp)) {
          currentStreak++;
        } else {
          break;
        }
      }
      
      const aboveSMACount = recent20.filter(d => d.isAboveSMA).length;
      const upInTrendCount = recent20.filter(d => d.isAboveSMA && d.isUp).length;
      const upStreakProb = aboveSMACount > 0 ? (upInTrendCount / aboveSMACount * 100) : 0;
      
      return {
        currentStreak: currentStreak + (streakType === 'up' ? 'æ—¥ä¸Šæ¼²' : 'æ—¥ä¸‹è·Œ'),
        upStreakProb: upStreakProb.toFixed(1),
        pattern: recent20.map(d => d.isUp ? 'up' : 'down'),
